name: Sync Docker Images

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v2

      - name: Debug Secrets
        run: |
          if [ -n "${{ secrets.DOCKERHUB_USERNAME }}" ]; then
            echo "DOCKERHUB_USERNAME is set"
          else
            echo "DOCKERHUB_USERNAME is not set"
          fi
          if [ -n "${{ secrets.DOCKERHUB_TOKEN }}" ]; then
            echo "DOCKERHUB_TOKEN is set"
          else
            echo "DOCKERHUB_TOKEN is not set"
          fi

      # 添加此步骤来配置Docker允许不安全registry
      - name: Configure Docker daemon
        run: |
          echo '{ "insecure-registries": ["119.23.251.91:5000"] }' | sudo tee /etc/docker/daemon.json
          sudo service docker restart

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Login to Private Registry
        uses: docker/login-action@v2
        with:
          registry: 119.23.251.91:5000
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}
          insecure: true  # 添加这行来允许不安全连接

      - name: Sync images
        run: |
          while IFS= read -r image; do
            [ -z "$image" ] || [[ "$image" =~ ^#.* ]] && continue
            echo "Syncing $image..."
            docker pull $image
            new_image="119.23.251.91:5000/${image#*/}"
            docker tag $image $new_image
            docker push $new_image
          done < images.txt
